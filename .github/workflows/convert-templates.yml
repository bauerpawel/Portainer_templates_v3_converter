name: Convert Portainer Templates v2 to v3

on:
  # Uruchamianie workflow ręcznie z poziomu GitHub UI
  workflow_dispatch:

  # Automatyczne uruchamianie raz dziennie o 2:00 UTC
  schedule:
    - cron: '0 2 * * *'

  # Uruchamianie przy pushu do gałęzi głównej (opcjonalne)
  push:
    branches:
      - main
      - master
    paths:
      - 'portainer_converter.py'
      - 'schema_v3.json'
      - '.github/workflows/convert-templates.yml'

jobs:
  convert:
    name: Convert and Upload Templates
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run conversion script
        run: |
          python portainer_converter.py --all-sources

      - name: Check if templates file was generated
        run: |
          if [ ! -f templates_v3_converted.json ]; then
            echo "Error: templates_v3_converted.json was not generated"
            exit 1
          fi
          echo "File size: $(du -h templates_v3_converted.json | cut -f1)"
          echo "Templates count: $(jq '.templates | length' templates_v3_converted.json)"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push changes
        run: |
          git add templates_v3_converted.json

          # Sprawdź czy są zmiany do zacommitowania
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update converted Portainer templates v3

          Auto-generated by GitHub Actions
          Conversion date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push
            echo "Templates updated successfully!"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## Conversion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f templates_v3_converted.json ]; then
            TEMPLATES_COUNT=$(jq '.templates | length' templates_v3_converted.json)
            FILE_SIZE=$(du -h templates_v3_converted.json | cut -f1)

            echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Templates converted**: $TEMPLATES_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **File size**: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **File**: \`templates_v3_converted.json\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Error**: templates_v3_converted.json was not generated" >> $GITHUB_STEP_SUMMARY
          fi
